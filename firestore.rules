
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helper functions for roles and authentication status
    function isSignedIn() {
      return request.auth != null;
    }

    function isApproved() {
      // isApproved is a field in the user's document in the /users collection.
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isApproved == true;
    }

    function isRole(role) {
      return isApproved() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isEditor() {
      return isRole('editor');
    }

    function isSupervisor() {
      return isRole('supervisor');
    }
    
    function isViewer() {
      return isRole('viewer');
    }
    
    function canReadCollection() {
      return isEditor() || isViewer();
    }
    
    function canWriteCollection() {
      return isEditor();
    }

    // === User Profiles ===
    match /users/{userId} {
      // Allow a user to read their own profile, or allow editors/viewers to read all profiles.
      allow read: if canReadCollection() || request.auth.uid == userId;
      
      // Allow a user to create their own profile document.
      // After creation, only editors can write/update profiles.
      allow create: if request.auth.uid == userId || isEditor();
      allow update, delete: if isEditor();
    }

    // === Main File Entries (Deposit Works) ===
    match /fileEntries/{docId} {
      // Supervisors can read a file if their UID is in the assigned list.
      // Editors and Viewers can read all files.
      allow read: if canReadCollection() || (isSupervisor() && request.auth.uid in resource.data.assignedSupervisorUids);
      allow create, delete: if canWriteCollection();
      // Updates are handled through the 'pendingUpdates' collection workflow.
      allow update: if isEditor();
    }

    // === ARS Entries ===
    match /arsEntries/{docId} {
      // Supervisors can get an ARS entry if their UID matches.
      allow get: if canReadCollection() || (isSupervisor() && resource.data.supervisorUid == request.auth.uid);
      allow list: if canReadCollection() || isSupervisor();
      allow create, update, delete: if canWriteCollection();
    }
    
    // === Pending Updates from Supervisors ===
    match /pendingUpdates/{docId} {
      allow create: if isSupervisor() || isEditor();
      allow read, delete: if (isSupervisor() && request.auth.uid == resource.data.submittedByUid) || isEditor();
      allow update: if isEditor(); // Editors approve/reject by updating status
    }

    // === Staff Members (Establishment) ===
    match /staffMembers/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === Agency Registrations ===
    match /agencyApplications/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === GWD Rates ===
    match /gwdRates/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === eTenders ===
    match /eTenders/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    // === Bidders ===
    match /bidders/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }

    // === Vehicle Management ===
    match /departmentVehicles/{docId} {
      allow read: if canReadCollection() || isSupervisor();
      allow write: if isEditor();
    }

    match /hiredVehicles/{docId} {
      allow read: if canReadCollection() || isSupervisor();
      allow write: if isEditor();
    }

    match /rigCompressors/{docId} {
      allow read: if canReadCollection() || isSupervisor();
      allow write: if isEditor();
    }

    // === App Settings (Dropdowns, etc.) ===
    match /officeAddresses/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    match /localSelfGovernments/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }

    match /constituencies/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
    
    match /rateDescriptions/{docId} {
      allow read: if isApproved();
      allow write: if isEditor();
    }
  }
}
